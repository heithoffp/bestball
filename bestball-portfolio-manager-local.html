<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Best Ball Portfolio Manager (Fixed)</title>

    <!-- TODO (MVP): Consider replacing CDN React/Babel with a build step once MVP stabilizes -->

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- TODO (MVP): Add charting library (Chart.js / Recharts / D3) for ADP scatter + time-series -->

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #141824;
            --bg-hover: #1a1f2e;
            --border: #2a3142;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-dark); color: var(--text-primary); }
        .app-container { min-height: 100vh; padding: 2rem; }
        h1 { font-family: 'JetBrains Mono', monospace; font-size: 2rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .config-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; }
        .path-input { width: 100%; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace; }
        .load-button { background: var(--gradient-primary); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .load-button:hover { transform: translateY(-2px); }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); }
        .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-rb { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .badge-wr { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .badge-qb { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .badge-te { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const [config, setConfig] = useState({ rosterPath: '', adpPath: '' });
            const [rosterData, setRosterData] = useState([]);
            const [activeTab, setActiveTab] = useState('exposures');

            // TODO (MVP): Extend masterPlayers to include:
            // - unique internal player_id
            // - rookie flag (derived or manually assigned)
            // - historical ADP array (for time-series)
            const [masterPlayers, setMasterPlayers] = useState([]);

            // TODO (MVP): Store raw ADP rows with timestamps for time-series charts
            const [status, setStatus] = useState({ type: '', msg: '' });

            // Load Config
            useEffect(() => {
                const stored = localStorage.getItem('bb_config_v2');
                if (stored) setConfig(JSON.parse(stored));
            }, []);

            const saveConfig = () => {
                localStorage.setItem('bb_config_v2', JSON.stringify(config));
                loadFiles();
            };

            const parseCSV = (text) => {
                return new Promise(resolve => {
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => resolve(res.data)
                    });
                });
            };

            // TODO (MVP): Improve name normalization
            // - lowercase
            // - strip suffixes (Jr, Sr, III)
            // - normalize special characters
            const normalizeName = (n) => n ? n.trim().replace(/\s+/g, ' ') : 'Unknown';

            const loadFiles = async () => {
                setStatus({ type: 'loading', msg: 'Loading...' });
                try {
                    // =============================
                    // CSV Upload & Parsing (MVP)
                    // =============================
                    // TODO (MVP): Support drag-and-drop file upload (File API)
                    // TODO (MVP): Add column-mapping UI instead of hard-coded column names

                    if (!config.rosterPath) throw new Error("Please enter a Roster CSV path");
                    const rRes = await fetch(config.rosterPath);
                    if (!rRes.ok) throw new Error(`Could not find file: ${config.rosterPath}`);
                    const rText = await rRes.text();
                    const rParsed = await parseCSV(rText);

                    const mappedRosters = rParsed.map(row => {
                        let name = row['Player Name'] || row.player_name || row.Player;
                        if (!name && (row['First Name'] || row.firstName)) {
                            name = `${row['First Name'] || row.firstName || ''} ${row['Last Name'] || row.lastName || ''}`;
                        }

                        const entry = row['Draft Entry'] || row['Entry ID'] || row.entry_id || 'Entry1';
                        const pick = parseInt(row['Pick Number'] || row.pick_number || row.Pick || 0);
                        const draftSize = parseInt(row['Draft Size'] || 12);
                        const round = row['Round'] || (pick > 0 ? Math.ceil(pick / draftSize) : '-');

                        return {
                            name: normalizeName(name),
                            position: row['Position'] || row.position || 'N/A',
                            team: row['Team'] || row.team || 'N/A',
                            entry_id: entry,
                            pick: pick,
                            round: round
                        };
                    }).filter(p => p.name !== 'Unknown');

                    setRosterData(mappedRosters);

                    // =============================
                    // ADP Load (MVP)
                    // =============================
                    // TODO (MVP): Store ADP snapshots with timestamps
                    // TODO (MVP): Allow multiple ADP uploads to build time-series

                    let adpMap = {};
                    if (config.adpPath) {
                        try {
                            const aRes = await fetch(config.adpPath);
                            if (aRes.ok) {
                                const aText = await aRes.text();
                                const aParsed = await parseCSV(aText);
                                aParsed.forEach(row => {
                                    const name = normalizeName(`${row.firstName || ''} ${row.lastName || ''}`);
                                    if (name !== 'Unknown') {
                                        adpMap[name] = {
                                            adp: parseFloat(row.adp || 0),
                                            proj: parseFloat(row.projectedPoints || 0)
                                        };
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn("ADP Load failed", e);
                        }
                    }

                    processMasterList(mappedRosters, adpMap);
                    setStatus({ type: 'success', msg: `Loaded ${mappedRosters.length} players.` });

                } catch (err) {
                    setStatus({ type: 'error', msg: err.message });
                }
            };

            const stableId = (input) => {
                let hash = 0;
                for (let i = 0; i < input.length; i++) {
                    hash = ((hash << 5) - hash) + input.charCodeAt(i);
                    hash |= 0;
                }
                return `p_${Math.abs(hash)}`;
            };

            const processMasterList = (rosters, adpMap) => {
                const totalEntries = new Set(rosters.map(r => r.entry_id)).size;

                // =============================
                // Canonical Player Table (MVP)
                // =============================
                // TODO (MVP): Generate stable player_id (hash of name+team+position)
                // TODO (MVP): Detect rookies (via external list or year drafted)
                // TODO (MVP): Store per-player list of draft picks (for avg ADP calc)

                const playerMap = {};

                rosters.forEach(r => {
                    if (!playerMap[r.name]) {
                        const canonicalKey = `${r.name}|${r.position}|${r.team}`;
                        playerMap[r.name] = {
                            player_id: stableId(canonicalKey),
                            name: r.name,
                            position: r.position,
                            team: r.team,
                            rookie: false,
                            count: 0,
                            entries: [],
                            adp: adpMap[r.name]?.adp || '-'
                        };
                    }
                    playerMap[r.name].count++;
                    playerMap[r.name].entries.push(r.entry_id);
                });

                const final = Object.values(playerMap).map(p => ({
                    ...p,
                    exposure: ((p.count / totalEntries) * 100).toFixed(1)
                }))
                .sort((a,b) => parseFloat(b.exposure) - parseFloat(a.exposure));

                setMasterPlayers(final);
            };

            return (
                <div className="app-container">
                    <h1>BEST BALL MANAGER</h1>

                    <div className="config-section">
                        {/* TODO (MVP): Replace path-based loading with file picker UI */}
                        <label>Roster CSV Path</label>
                        <input className="path-input" value={config.rosterPath}
                            onChange={e => setConfig({...config, rosterPath: e.target.value})} />

                        <label>ADP CSV Path</label>
                        <input className="path-input" value={config.adpPath}
                            onChange={e => setConfig({...config, adpPath: e.target.value})} />

                        <button className="load-button" onClick={saveConfig}>Load Data</button>
                    </div>

                    {/* =============================
                        Portfolio Overview (MVP)
                       ============================= */}
                    {/* TODO (MVP): Add filters by:
                        - position
                        - team
                        - individual entry
                    */}

                    {/* =============================
                        Exposure Summary Dashboard (MVP)
                       ============================= */}
                    {/* TODO (MVP): Add charts:
                        - exposure by position
                        - exposure by team
                    */}

                    {masterPlayers.length > 0 && (
                        <div className="card">
                            <div className="tab-bar">
                                <button
                                    className={`tab-button ${activeTab === 'exposures' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('exposures')}
                                >
                                    Top Exposures
                                </button>
                                <button
                                    className={`tab-button ${activeTab === 'canonical' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('canonical')}
                                >
                                    Canonical Player Table
                                </button>
                            </div>

                            {activeTab === 'exposures' && (
                                <>
                                    <h2>Top Exposures</h2>

                                    {/* TODO (MVP): Add sortable columns */}
                                    {/* TODO (MVP): Add exposure threshold highlighting */}

                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Player</th>
                                                <th>Pos</th>
                                                <th>Team</th>
                                                <th>Exposure</th>
                                                <th>ADP</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {masterPlayers.slice(0, 50).map(p => (
                                                <tr key={p.name}>
                                                    <td>{p.name}</td>
                                                    <td>{p.position}</td>
                                                    <td>{p.team}</td>
                                                    <td>{p.exposure}% ({p.count})</td>
                                                    <td>{p.adp}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </>
                            )}

                            {activeTab === 'canonical' && (
                                <>
                                    <h2>Canonical Player Table</h2>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Player ID</th>
                                                <th>Player</th>
                                                <th>Pos</th>
                                                <th>Team</th>
                                                <th>Rookie</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {masterPlayers.map(p => (
                                                <tr key={p.player_id}>
                                                    <td>{p.player_id}</td>
                                                    <td>{p.name}</td>
                                                    <td>{p.position}</td>
                                                    <td>{p.team}</td>
                                                    <td>{p.rookie ? 'Yes' : 'No'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </>
                            )}
                        </div>
                    )}

                    {/* =============================
                        ADP vs Exposure Analysis (MVP)
                       ============================= */}
                    {/* TODO (MVP): Scatter plot:
                        X = ADP
                        Y = Exposure %
                        Bubble size = count
                    */}
                    {/* TODO (MVP): Highlight players where exposure deviates from ADP expectation */}

                    {/* =============================
                        ADP Time-Series (MVP)
                       ============================= */}
                    {/* TODO (MVP): Line chart of ADP over time */}
                    {/* TODO (MVP): Player selector with comparison overlay */}
                    {/* TODO (MVP): Mark draft events on timeline */}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
